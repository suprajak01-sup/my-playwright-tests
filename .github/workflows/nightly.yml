name: Nightly Report & Deploy

on:
  schedule:
    - cron: '0 0 * * *' # Runs at Midnight UTC
  workflow_dispatch:      # Allows manual trigger

# PERMISSIONS: Critical for deploying to Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Dependencies
        run: npm ci && npx playwright install --with-deps

      - name: Run Playwright Tests
        run: npx playwright test
        continue-on-error: true # IMPORTANT: Don't stop if tests fail! We need to see the report.

      # 1. PREPARE THE REPORT FOR WEB
      # Playwright generates a 'playwright-report' folder. 
      # We upload this specific folder to GitHub Pages.
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Report Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'playwright-report/'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

     # 2. SEND THE LINK VIA EMAIL
      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
        # CHANGE 1: Use the TLS server address
          server_address: smtp.gmail.com
        
        # CHANGE 2: Use Port 587 (Standard for App Passwords)
          server_port: 587
        
        # CHANGE 3: Set secure to false (Triggers STARTTLS)
          secure: false
        
        # CREDENTIALS
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
        
        # CONTENT (Added quotes to prevent YAML errors)
          subject: "Nightly Results: ${{ job.status }}"
          to: "suprajak01@gmail.com"
          from: ${{ secrets.EMAIL_USERNAME }} # Simplify this temporarily
        
          body: |
          <h3>Nightly Regression Run: ${{ job.status }}</h3>
            <p>The nightly run has finished.</p>
            <p>The latest test report is now live.</p>
            <p><b>ðŸ‘‰ View Dashboard:</b> <a href="${{ steps.deployment.outputs.page_url }}">Click Here to Open Report</a></p>
            <p><i>(This link always shows the most recent run)</i></p>
